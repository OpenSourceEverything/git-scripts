#!/usr/bin/env bash
set -euo pipefail

# Force-push with lease to a remote (rewrites remote history if lease allows).
# Manual equivalent:
#   git push --force-with-lease [git-push-args...]
usage() {
  cat <<'EOF'
Usage: git-push-force-lease --yes [git-push-args...]

Force-push with lease. This can rewrite remote history.

Options:
  -y, --yes, --confirm  Enable remote modification
  -h, --help, -help     Show help
EOF
}

# Parse flags while preserving extra args for git push.
confirm=0
args=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help|-help)
      usage
      exit 0
      ;;
    -y|--yes|--confirm)
      confirm=1
      ;;
    --)
      shift
      args+=("$@")
      break
      ;;
    *)
      args+=("$1")
      ;;
  esac
  shift
done

# Require explicit confirmation to modify the remote.
if [[ "$confirm" -ne 1 ]]; then
  echo "Remote modification is disabled by default. Re-run with --yes." >&2
  usage >&2
  exit 1
fi

# Execute the git command, passing through any extra args.
git push --force-with-lease "${args[@]}"
