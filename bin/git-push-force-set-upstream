#!/usr/bin/env bash
set -euo pipefail

# Force-push and set upstream tracking.
# Manual equivalent:
#   git push -u <remote> <branch> --force
usage() {
  cat <<'EOF'
Usage: git-push-force-set-upstream --yes <branch> [remote]

Force-push and set upstream tracking for a branch.

Options:
  -y, --yes, --confirm  Enable remote modification
  -h, --help, -help     Show help
EOF
}

# Parse flags while preserving positional args.
confirm=0
args=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help|-help)
      usage
      exit 0
      ;;
    -y|--yes|--confirm)
      confirm=1
      ;;
    --)
      shift
      args+=("$@")
      break
      ;;
    *)
      args+=("$1")
      ;;
  esac
  shift
done

# Require explicit confirmation to modify the remote.
if [[ "$confirm" -ne 1 ]]; then
  echo "Remote modification is disabled by default. Re-run with --yes." >&2
  usage >&2
  exit 1
fi

# Validate required args.
if [[ ${#args[@]} -lt 1 ]]; then
  echo "Missing required argument: <branch>" >&2
  usage >&2
  exit 1
fi
if [[ ${#args[@]} -gt 2 ]]; then
  echo "Too many arguments: ${args[*]}" >&2
  usage >&2
  exit 1
fi

# Use the provided branch and optional remote.
branch="${args[0]}"
remote="${args[1]:-origin}"

# Execute the git command.
git push -u "$remote" "$branch" --force
